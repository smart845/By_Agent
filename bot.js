
import os
import json
import random
import requests

# =============== –ù–ê–°–¢–†–û–ô–ö–ò ===============

TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")

# =============== –ü–ê–ú–Ø–¢–¨ ===============
# chat_id -> {"history": [...], "last_intent": str}
MEMORY = {}

# =============== –°–ü–†–ê–í–û–ß–ù–´–ï –î–ê–ù–ù–´–ï ===============

TIMEFRAMES = [
    "–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–Ω–µ–π",
    "–Ω–µ–¥–µ–ª–∏",
    "–¥–≤—É—Ö –Ω–µ–¥–µ–ª—å",
    "–º–µ—Å—è—Ü–∞",
    "–¥–≤—É—Ö-—Ç—Ä—ë—Ö –º–µ—Å—è—Ü–µ–≤",
    "–ª—É–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞",
    "–±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏",
    "–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—è—Ü–µ–≤",
]

CRYPTO_KEYWORDS = [
    "–∫—Ä–∏–ø—Ç", "–±–∏—Ç–æ–∫", "–±–∏—Ç–∫–æ–∏–Ω", "bitcoin", "—ç—Ñ–∏—Ä", "ether", "eth",
    "altcoin", "–∞–ª—å—Ç", "–∞–ª—å—Ç—ã", "—Ç–æ–∫–µ–Ω", "–º–æ–Ω–µ—Ç", "coin", "–∫–æ–∏–Ω",
    "—á–∞—Ä—Ç", "–≥—Ä–∞—Ñ–∏–∫", "—à–æ—Ä—Ç", "–ª–æ–Ω–≥", "long", "short", "pump", "–ø–∞–º–ø",
    "–¥–∞–º–ø", "dump", "binance", "bybit", "okx", "futures", "—Ñ—å—é—á–µ—Ä—Å",
    "—Å–ø–æ—Ç", "spot", "dex", "cex",
]

def detect_intent(text: str) -> str:
    t = text.lower()
    if "–∫–æ–≥–¥–∞" in t:
        return "when"
    if "—Å—Ç–æ–∏—Ç –ª–∏" in t or "–µ—Å—Ç—å –ª–∏ —Å–º—ã—Å–ª" in t or "–Ω–∞–¥–æ –ª–∏" in t:
        return "should"
    if " –ª–∏ " in t or "–ø–æ–ª—É—á–∏—Ç—Å—è" in t or "—Å–º–æ–≥—É –ª–∏" in t or "–±—É–¥–µ—Ç –ª–∏" in t:
        return "yesno"
    return "open"


# =============== –§–†–ê–ó–´ –ó–ê–†–´ (–¢–Å–ú–ù–ê–Ø –ö–†–ò–ü–¢–û-–í–ï–î–¨–ú–ê) ===============

INTROS = [
    "üåòüßø {name}, –Ω–æ—á–Ω–æ–π —Ä—ã–Ω–æ–∫ —à–µ–ø—á–µ—Ç —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å‚Ä¶ —è —Å–ª—ã—à—É –µ–≥–æ –≤ —Ç—Ä–µ—Å–∫–µ —Å–≤–µ—á–µ–π.",
    "üåëüîÆ {name}, —Ç—å–º–∞ –Ω–∞–¥ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ —Å–≥—É—â–∞–µ—Ç—Å—è, –∏ –º–æ–Ω–µ—Ç—ã —à–µ–≤–µ–ª—è—Ç—Å—è, –∫–∞–∫ –¥—É—Ö–∏ –≤ –∫–∞–Ω–¥–∞–ª–∞—Ö.",
    "üåôüíπ {name}, —Ç—ã –ø—Ä–∏—à—ë–ª —Å –≤–æ–ø—Ä–æ—Å–æ–º –æ –∫—Ä–∏–ø—Ç–µ ‚Äî –∏ –ª—É–Ω–∞ –Ω–∞–¥ —Å–≤–µ—á–∞–º–∏ —Å—Ç–∞–ª–∞ —è—Ä—á–µ‚Ä¶",
    "üïØÔ∏èüßø {name}, —è —á—É–≤—Å—Ç–≤—É—é, –∫–∞–∫ —Ç—Ä–µ–≤–æ–≥–∞ –ø–æ –¥–µ–ø–æ–∑–∏—Ç—É —Å—Ç—É—á–∏—Ç —É —Ç–µ–±—è –≤ –≥—Ä—É–¥–∏ —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –±–∏—Ç–æ–∫ –ø–æ —Ä—ã–Ω–∫—É.",
    "üå´Ô∏èüìä {name}, —Ç—É–º–∞–Ω –Ω–∞–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º –≥—É—Å—Ç–æ–π, –Ω–æ –¥–ª—è –º–µ–Ω—è –ª–∏–Ω–∏–∏ —Å—É–¥—å–±—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –≤–∏–¥–Ω—ã‚Ä¶",
]

SIGNS = [
    "–ö–∞—Ä—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∑–Ω–∞–∫ *–î–∏–∫–æ–≥–æ —Ä—ã–Ω–∫–∞* ‚Äî —Ö–∞–æ—Å, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ—Ä–≤—ã –Ω–∞ –ø—Ä–µ–¥–µ–ª–µ.",
    "–ü–µ—Ä–µ–¥–æ –º–Ω–æ–π –≤—Å–ø—ã—Ö–∏–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª *–°–≤–µ—á–∏-–±–µ–∑—É–º—Ü–∞* ‚Äî —Ä–µ–∑–∫–∏–µ —Ç–µ–Ω–∏, –≤—Å–ø—ã—à–∫–∏ –≤–≤–µ—Ä—Ö –∏ –≤–Ω–∏–∑.",
    "–Ø –≤–∏–∂—É *–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –±–æ–∫–æ–≤–∏–∫* ‚Äî —ç–Ω–µ—Ä–≥–∏—è –∫–æ–ø–∏—Ç—Å—è, –Ω–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫—É–¥–∞ —Ä–≤–∞–Ω—ë—Ç.",
    "–ü–æ—è–≤–ª—è–µ—Ç—Å—è –∑–Ω–∞–∫ *–§–∞–Ω—Ç–æ–º–Ω–æ–≥–æ –ø–∞–º–ø–∞* ‚Äî —Ä–æ—Å—Ç, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ —á—É–¥–æ, –Ω–æ —Å –ø—Ä–∏–≤–∫—É—Å–æ–º –æ–±–º–∞–Ω–∞.",
    "–ö–∞—Ä—Ç–∞ —à–µ–ø—á–µ—Ç –æ *–ü–ª–µ—á–µ –±–µ—Å–æ–≤—Å–∫–æ–º* ‚Äî —Ç–æ, —á—Ç–æ –±—ã—Å—Ç—Ä–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç, –º–æ–∂–µ—Ç —Ç–∞–∫ –∂–µ –±—ã—Å—Ç—Ä–æ —É—Ç—è–Ω—É—Ç—å –≤ –±–µ–∑–¥–Ω—É.",
    "–ü–æ—è–≤–ª—è–µ—Ç—Å—è –∑–Ω–∞–∫ *–£—Å—Ç–∞–≤—à–µ–≥–æ —Ç—Ä–µ–Ω–¥–∞* ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ —É–∂–µ —Ö–æ—á–µ—Ç –ª–µ—á—å —Å–ø–∞—Ç—å, –∞ –Ω–µ –±–µ–∂–∞—Ç—å –¥–∞–ª—å—à–µ.",
    "–Ø –≤–∏–∂—É —Å–∏–º–≤–æ–ª *–ó–ª–æ–π –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏* ‚Äî —Ç–∞–º, –≥–¥–µ —Å–æ–±–µ—Ä—É—Ç —Å—Ç–æ–ø—ã —Ç–µ—Ö, –∫—Ç–æ –∑–∞—à—ë–ª –±–µ–∑ –ø–ª–∞–Ω–∞.",
    "–ö–∞—Ä—Ç—ã –≥–æ–≤–æ—Ä—è—Ç –æ *–ú–æ–Ω–µ—Ç–µ-–ø—Ä–∏–∑—Ä–∞–∫–µ* ‚Äî –º–Ω–æ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤, –º–∞–ª–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±—ä—ë–º–∞.",
]

INTERP = [
    "–≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ —Ä—ã–Ω–æ–∫ —Å–µ–π—á–∞—Å –±–æ–ª—å—à–µ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç —Ç–≤–æ—é –≤—ã–¥–µ—Ä–∂–∫—É, —á–µ–º —Ç–≤–æ–π –∞–Ω–∞–ª–∏–∑.",
    "–í–∏–∂—É, –∫–∞–∫ —Å—Ç—Ä–∞—Ö —É–ø—É—Å—Ç–∏—Ç—å —à–∞–Ω—Å –±–æ—Ä–µ—Ç—Å—è –≤ —Ç–µ–±–µ —Å–æ —Å—Ç—Ä–∞—Ö–æ–º –ø–æ—Ç–µ—Ä—è—Ç—å ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –±–∏—Ç–≤–∞ –Ω–∞ –∫—Ä–∏–ø—Ç–æ—Ä—ã–Ω–∫–µ.",
    "–°—É–¥—å–±–∞ –Ω–∞–º–µ–∫–∞–µ—Ç: –µ—Å–ª–∏ —ç–º–æ—Ü–∏–∏ —Ä—É–ª—è—Ç –≤—Ö–æ–¥–æ–º –∏ –≤—ã—Ö–æ–¥–æ–º ‚Äî —Ä—ã–Ω–æ–∫ —É–∂–µ –≤—ã–∏–≥—Ä–∞–ª –µ—â—ë –¥–æ —Å–¥–µ–ª–∫–∏.",
    "–ü–æ—Ö–æ–∂–µ, —Ç—ã —Å–ª–∏—à–∫–æ–º —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ —á—É–∂–∏–µ —Å–∫—Ä–∏–Ω—ã –ø—Ä–æ—Ñ–∏—Ç–∞ –∏ –º–∞–ª–æ ‚Äî –Ω–∞ —Å–≤–æ–π —Ä–∏—Å–∫ –∏ –ø—Ä–∞–≤–∏–ª–∞.",
    "–ë–æ–ª—å—à–∞—è —á–∞—Å—Ç—å –±–æ–ª–∏ –≤ –∫—Ä–∏–ø—Ç–µ ‚Äî –Ω–µ –æ—Ç —Å–≤–µ—á–µ–π, –∞ –æ—Ç –æ–∂–∏–¥–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã —Å–∞–º —Å–µ–±–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–ª.",
    "–ó–¥–µ—Å—å —è –≤–∏–∂—É, —á—Ç–æ —Ç—ã –∏—â–µ—à—å –æ–¥–∏–Ω –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥‚Ä¶ –∞ —Ä—ã–Ω–æ–∫ –ª—é–±–∏—Ç —Ç–µ—Ö, –∫—Ç–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ, –∞ –Ω–µ –ø–æ –≤–æ–ª—à–µ–±–Ω–æ–π —Ç–æ—á–∫–µ.",
    "–≠–Ω–µ—Ä–≥–∏—è –≤–æ–ø—Ä–æ—Å–∞ —Ç—è–∂—ë–ª–∞—è: –Ω–µ –º–æ–Ω–µ—Ç–∞ –æ–ø–∞—Å–Ω–∞, –∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –Ω–µ–π ‚Äî –∫–∞–∫ –∫ –ª–æ—Ç–µ—Ä–µ–π–Ω–æ–º—É –±–∏–ª–µ—Ç—É.",
]

ANSWERS_YESNO = [
    "‚úî –ü–æ –ø—Ä–∞–≤–¥–µ —Å–∫–∞–∂—É: **—Å–∫–æ—Ä–µ–µ –¥–∞, —à–∞–Ω—Å —Ö–æ—Ä–æ—à**, –Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –Ω–µ –∑–∞—Ö–æ–¥–∏—à—å –≤—Å–µ–º –¥–µ–ø–æ–∑–∏—Ç–æ–º, –±—É–¥—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –∂–∏–∑–Ω–∏.",
    "‚úî –°—É–¥—å–±–∞ —à–µ–ø—á–µ—Ç: **–µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ –ø–ª–∞–Ω—É ‚Äî –¥–∞, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –µ—Å—Ç—å**, –µ—Å–ª–∏ –≤–ª–µ—Ç–µ—Ç—å —Å —ç–º–æ—Ü–∏–π ‚Äî —Ä—ã–Ω–æ–∫ –∑–∞–±–µ—Ä—ë—Ç —Å–≤–æ—ë.",
    "‚úî –í–∏–∂—É: **–¥–ª—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–π–¥–µ—Ä–∞ —ç—Ç–æ ‚Äú–¥–∞‚Äù**, –¥–ª—è –∞–∑–∞—Ä—Ç–Ω–æ–≥–æ ‚Äî –≥—Ä–æ–º–∫–æ–µ ‚Äú–Ω–µ—Ç‚Äù.",
]

ANSWERS_WHEN = [
    "‚úî –ü–æ —Å—Ä–æ–∫–∞–º: **—á—ë—Ç–∫–æ–π –¥–∞—Ç—ã —Å—É–¥—å–±–∞ –Ω–µ –¥–∞—ë—Ç**, –Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ {timeframe} —Ä—ã–Ω–æ–∫ –ø–æ–∫–∞–∂–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ, –≥–¥–µ –≤–∞–∂–Ω–µ–µ –±—ã—Ç—å –≥–æ—Ç–æ–≤—ã–º, —á–µ–º —É–≥–∞–¥—ã–≤–∞—Ç—å —Å–≤–µ—á—É.",
    "‚úî –ö–∞—Ä—Ç—ã —à–µ–ø—á—É—Ç: **–µ—â—ë {timeframe} —Ä—ã–Ω–æ–∫ –±—É–¥–µ—Ç –∏—Å–ø—ã—Ç—ã–≤–∞—Ç—å —Ç–µ—Ä–ø–µ–Ω–∏–µ, –∞ –ø–æ—Ç–æ–º –ø–æ–∫–∞–∂–µ—Ç –±–æ–ª–µ–µ —è—Å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**.",
    "‚úî –í–∏–∂—É: **–¥–ª—è —Ç–µ–±—è –∫—Ä–∏—Ç–∏—á–Ω—ã–º –±—É–¥–µ—Ç –ø–µ—Ä–∏–æ–¥ –æ–∫–æ–ª–æ {timeframe}** ‚Äî –µ—Å–ª–∏ –∫ —Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É —Ç—ã –≤—ã—Ä–∞–±–æ—Ç–∞–µ—à—å —Å–≤–æ—é —Å–∏—Å—Ç–µ–º—É.",
]

ANSWERS_SHOULD = [
    "‚úî –°–æ–≤–µ—Ç –≤–µ–¥—å–º—ã —Ä—ã–Ω–∫–∞: **–≤—Ö–æ–¥–∏—Ç—å —Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ —Å —Ç–µ–º, —á—Ç–æ –Ω–µ –∂–∞–ª–∫–æ –ø–æ—Ç–µ—Ä—è—Ç—å**, –∏ –ª–∏—à—å —Ç—É–¥–∞, —á—Ç–æ —Ç—ã —Å–∞–º –ø–æ–Ω–∏–º–∞–µ—à—å, –∞ –Ω–µ –ø–æ —Å–ª–æ–≤–∞–º –∏–∑ —á–∞—Ç–∞.",
    "‚úî –°–ª—ã—à—É —è: **–µ—Å–ª–∏ —Ç—ã –Ω–µ –º–æ–∂–µ—à—å —Å–ø–æ–∫–æ–π–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø—Ä–æ—Å–∞–¥–∫—É ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–π –ø–ª–µ—á–∏ –∏ –±–æ–ª—å—à–∏–µ –æ–±—ä—ë–º—ã**.",
    "‚úî –û—Ç–≤–µ—Ç —Ç–∞–∫–æ–π: **—Å–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏ —Å–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ –≤—Ö–æ–¥–∞ –∏ –≤—ã—Ö–æ–¥–∞, –∞ —É–∂–µ –ø–æ—Ç–æ–º —Å–ø—Ä–∞—à–∏–≤–∞–π —Å—É–¥—å–±—É, —Å—Ç–æ–∏—Ç –ª–∏ –∑–∞—Ö–æ–¥–∏—Ç—å.**",
]

ANSWERS_OPEN = [
    "‚úî –û–±—â–∏–π –ø—Ä–æ–≥–Ω–æ–∑: **–∫—Ä–∏–ø—Ç–∞ –µ—â—ë –ø–æ–∫–∞–∂–µ—Ç –∏ –ø–∞–º–ø—ã, –∏ –¥–∞–º–ø—ã**, –≥–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ–±—ã —Ç–≤–æ—è –ø—Å–∏—Ö–∏–∫–∞ –≤—ã–∂–∏–ª–∞ –≤–º–µ—Å—Ç–µ —Å –¥–µ–ø–æ–∑–∏—Ç–æ–º.",
    "‚úî –°—É–¥—å–±–∞ —à–µ–ø—á–µ—Ç: **—Ä—ã–Ω–æ–∫ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –¥–ª—è —Ç–µ–±—è —à–∫–æ–ª–æ–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã**, –µ—Å–ª–∏ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—à—å –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –Ω–µ–º—É –∫–∞–∫ –∫ –∫–∞–∑–∏–Ω–æ.",
    "‚úî –í–∏–∂—É: **—Ç–≤–æ—è –Ω–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–∏–±—ã–ª—å –±—É–¥–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –º–æ–Ω–µ—Ç–∞—Ö, –Ω–æ –∏ –≤ –æ–ø—ã—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —á–µ—Ä–µ–∑ –≤—Å—ë —ç—Ç–æ –ø—Ä–æ–π–¥—ë—à—å.**",
    "‚úî –ü—Ä–æ–≥–Ω–æ–∑ —Ç–∞–∫–æ–π: –¥–≤–∏–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç, –Ω–æ **–Ω–µ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ –∏ –Ω–µ —Ç–∞–∫ —Ä–æ–≤–Ω–æ, –∫–∞–∫ —Ç–µ–±–µ —Ä–∏—Å—É–µ—Ç —Ñ–∞–Ω—Ç–∞–∑–∏—è**.",
]

ENDINGS = [
    "üåíüßø –ó–∞–ø–æ–º–Ω–∏: —Ä—ã–Ω–æ–∫ —Å–ª—ã—à–∏—Ç —Ç–µ—Ö, –∫—Ç–æ —É–≤–∞–∂–∞–µ—Ç —Ä–∏—Å–∫, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∂–∞–∂–¥–µ—Ç –ø—Ä–æ—Ñ–∏—Ç–∞.",
    "üåòüîÆ –ö–∞—Ä—Ç—ã —Å–∫–∞–∑–∞–ª–∏ —Å–≤–æ—ë‚Ä¶ –Ω–µ –ø—Ä–µ–¥–∞–≤–∞–π —Å–µ–±—è —Ä–∞–¥–∏ —á—É–∂–∏—Ö –æ–∂–∏–¥–∞–Ω–∏–π –∏ —á—É–∂–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.",
    "üåë‚ú® –ü–æ–º–Ω–∏, –∑–æ–ª–æ—Ç—Ü–µ –º–æ—ë: —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ ‚Äî –Ω–µ –∫—Ä–∞—Å–Ω–∞—è —Å–≤–µ—á–∞, –∞ –ø–æ—Ç–µ—Ä—è–Ω–Ω–∞—è –≥–æ–ª–æ–≤–∞.",
    "üåôüíπ –ü—É—Å—Ç—å —Ä—ã–Ω–æ–∫ –±—É–¥–µ—Ç —Ç–≤–æ–∏–º —É—á–∏—Ç–µ–ª–µ–º, –∞ –Ω–µ –ø–∞–ª–∞—á–æ–º.",
]

# =============== –ü–ê–ú–Ø–¢–ù–´–ï –§–†–ê–ó–´ (–¢–Å–ú–ù–ê–Ø –ú–ò–°–¢–ò–ö–ê) ===============

MEMORY_REPEAT_INTENT = [
    "üåò‚ôæ {name}, —Ç—ã —Å–Ω–æ–≤–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å –æ–± –æ–¥–Ω–æ–º –∏ —Ç–æ–º –∂–µ‚Ä¶ –≤–∏–¥–Ω–æ, –æ—Ç–≤–µ—Ç —Å—É–¥—å–±—ã —Ç–µ–±–µ –ø–æ–∫–∞ –Ω–µ –ø–æ –¥—É—à–µ.",
    "üåëüßø –Ø —á—É–≤—Å—Ç–≤—É—é –ø–æ–≤—Ç–æ—Ä ‚Äî —Ä—ã–Ω–æ–∫ —É–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª —Ç–µ–±–µ —ç—Ç–æ—Ç —É—Ä–æ–∫, –∞ —Ç—ã –≤—Å—ë —Ö–æ–¥–∏—à—å –ø–æ –∫—Ä—É–≥—É.",
    "üåíüîÆ –≠–Ω–µ—Ä–≥–∏—è –≤–æ–ø—Ä–æ—Å–∞ —Ç–∞ –∂–µ‚Ä¶ –∑–Ω–∞—á–∏—Ç, –≤–Ω—É—Ç—Ä–∏ —É —Ç–µ–±—è –æ—Ç–≤–µ—Ç —É–∂–µ –µ—Å—Ç—å, –Ω–æ —Ç—ã –±–æ–∏—à—å—Å—è –µ–≥–æ –ø—Ä–∏–Ω—è—Ç—å.",
]

MEMORY_NEW = [
    "üå´Ô∏è‚ú® –í–∏–∂—É —Å–º–µ–Ω—É –≤–µ—Ç—Ä–∞ ‚Äî —Ç–µ–ø–µ—Ä—å —Ç—ã —Å–º–æ—Ç—Ä–∏—à—å –Ω–∞ —Ä—ã–Ω–æ–∫ –ø–æ–¥ –¥—Ä—É–≥–∏–º —É–≥–ª–æ–º.",
    "üåôüîÆ –ù–æ–≤–∞—è —Ç–µ–Ω—å –ª–µ–≥–ª–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫, {name}‚Ä¶ –∑–Ω–∞—á–∏—Ç, –∏ –º—ã—Å–ª–∏ —Ç–≤–æ–∏ –Ω–∞—á–∞–ª–∏ –º–µ–Ω—è—Ç—å—Å—è.",
    "üååüßø –¢—ã –¥–≤–∏–≥–∞–µ—à—å—Å—è, –∫–∞–∫ –∏ —Ä—ã–Ω–æ–∫ ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫, –∑–∞—Å—Ç–æ–π —Ö—É–∂–µ –ª—é–±–æ–π –ø—Ä–æ—Å–∞–¥–∫–∏.",
]


def get_memory_effect(chat_id, intent, name):
    if chat_id not in MEMORY:
        return None
    hist = MEMORY[chat_id].get("history", [])
    if not hist:
        return None

    last_intent = MEMORY[chat_id].get("last_intent")
    candidates = []

    if last_intent == intent:
        candidates.append(random.choice(MEMORY_REPEAT_INTENT).format(name=name))
    else:
        candidates.append(random.choice(MEMORY_NEW).format(name=name))

    return random.choice(candidates) if candidates else None


def generate_prediction(name: str, question: str) -> str:
    intent = detect_intent(question)

    intro = random.choice(INTROS).format(name=name)
    sign = random.choice(SIGNS)
    interp = random.choice(INTERP)

    if intent == "yesno":
        ans = random.choice(ANSWERS_YESNO)
    elif intent == "when":
        ans = random.choice(ANSWERS_WHEN).format(timeframe=random.choice(TIMEFRAMES))
    elif intent == "should":
        ans = random.choice(ANSWERS_SHOULD)
    else:
        ans = random.choice(ANSWERS_OPEN)

    ending = random.choice(ENDINGS)

    return f"{intro}\n\n{sign}\n\n{interp}\n\n{ans}\n\n{ending}"


def send_message(chat_id, text):
    if not TELEGRAM_TOKEN:
        return
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    try:
        requests.post(url, json={"chat_id": chat_id, "text": text})
    except Exception:
        pass


def handle_start(chat_id, name):
    text = (
        f"üåëüîÆ –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π, {name}.\n\n"
        "–Ø ‚Äî *–ó–∞—Ä–∞*, —Ç—ë–º–Ω–∞—è —Ü—ã–≥–∞–Ω–∫–∞-–≤–µ–¥—å–º–∞ –∫—Ä–∏–ø—Ç–æ—Ä—ã–Ω–∫–∞.\n"
        "–Ø —á–∏—Ç–∞—é —à—ë–ø–æ—Ç —Å–≤–µ—á–µ–π, –≤–∏–∂—É —Ç–µ–Ω–∏ –ø–∞–º–ø–æ–≤ –∏ —Å–ª—ã—à—É, –∫–∞–∫ —Ç–≤–æ–π –¥–µ–ø–æ–∑–∏—Ç –¥—Ä–æ–∂–∏—Ç –≤–º–µ—Å—Ç–µ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º.\n\n"
        "üßø –ß—Ç–æ —è –¥–µ–ª–∞—é:\n"
        "‚Äî –≥–∞–¥–∞—é –Ω–∞ –º–æ–Ω–µ—Ç–∞—Ö, –¥–≤–∏–∂–µ–Ω–∏—è—Ö –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö\n"
        "‚Äî –ø–æ–º–æ–≥–∞—é —É–≤–∏–¥–µ—Ç—å, –≥–¥–µ —Ç–µ–±—è –≤–µ–¥—ë—Ç —Ä—ã–Ω–æ–∫, –∞ –≥–¥–µ ‚Äî —Ç–≤–æ—è –∂–∞–¥–Ω–æ—Å—Ç—å\n"
        "‚Äî –≥–æ–≤–æ—Ä—é –æ —Ä–∏—Å–∫–µ –∏ —Ç–µ—Ä–ø–µ–Ω–∏–∏, –∫–∞–∫ –≤–µ–¥—å–º–∞, —á—Ç–æ –ø–µ—Ä–µ–∂–∏–ª–∞ –Ω–µ –æ–¥–∏–Ω –¥–∞–º–ø\n\n"
        "–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å –æ –∫—Ä–∏–ø—Ç–µ: –º–æ–Ω–µ—Ç–∞, –≤—Ö–æ–¥, –≤—ã—Ö–æ–¥, –¥–≤–∏–∂–µ–Ω–∏–µ, —Å—Ä–æ–∫‚Ä¶\n"
        "–ê –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —è –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ—é—Å—å –Ω–∞ —Ä—ã–Ω–æ–∫ ‚Äî –Ω–∞–ø–∏—à–∏ /crypto\n\n"
        f"üåò –ù—É —á—Ç–æ, {name}, –æ —á—ë–º —Å–ø—Ä–æ—Å–∏—à—å –ó–∞—Ä—É?"
    )
    send_message(chat_id, text)


def handle_crypto_command(chat_id, name):
    text = (
        f"üíπüåë {name}, –¥–∞–≤–∞–π –≤–∑–≥–ª—è–Ω–µ–º –Ω–∞ —Ä—ã–Ω–æ–∫ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ.\n\n"
        "–û–ø–∏—à–∏ –º–Ω–µ –º–æ–Ω–µ—Ç—É –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—é: –≤—Ö–æ–¥, –≤—ã—Ö–æ–¥, —Ä–æ—Å—Ç, –ø–∞–¥–µ–Ω–∏–µ, —Å—Ä–æ–∫‚Ä¶\n"
        "–Ø –ø–æ—Å–º–æ—Ç—Ä—é, —á—Ç–æ —à–µ–ø—á—É—Ç —Å–≤–µ—á–∏ –∏ –∫–∞–∫ –≤–µ–¥—É—Ç —Å–µ–±—è –¥—É—Ö–∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.\n\n"
        "üßø –ß–µ–º —Ç–æ—á–Ω–µ–µ —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å, —Ç–µ–º –≥–ª—É–±–∂–µ –º–æ—ë –≤–∏–¥–µ–Ω–∏–µ."
    )
    send_message(chat_id, text)


def handler(request, response):
    try:
        body = json.loads(request.body or "{}")
    except Exception:
        body = {}

    message = body.get("message")
    if not message:
        return response.status(200).send("ok")

    chat = message.get("chat", {}) or {}
    chat_id = chat.get("id")
    if chat_id is None:
        return response.status(200).send("ok")

    text = message.get("text") or ""
    from_user = message.get("from", {}) or {}
    name = from_user.get("first_name") or "–∑–æ–ª–æ—Ç—Ü–µ"

    lower = text.strip().lower()

    if lower == "/start":
        handle_start(chat_id, name)
        return response.status(200).send("ok")

    if lower == "/crypto":
        handle_crypto_command(chat_id, name)
        return response.status(200).send("ok")

    intent = detect_intent(text)

    if chat_id not in MEMORY:
        MEMORY[chat_id] = {"history": [], "last_intent": None}

    memory_effect = get_memory_effect(chat_id, intent, name)
    prediction = generate_prediction(name, text)

    if memory_effect:
        prediction = memory_effect + "\n\n" + prediction

    MEMORY[chat_id]["history"].append({"question": text, "intent": intent})
    MEMORY[chat_id]["last_intent"] = intent

    send_message(chat_id, prediction)
    return response.status(200).send("ok"
