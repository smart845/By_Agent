<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#120a22"/>
  <title>ByAgent Terminal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://unpkg.com/@tonconnect/sdk@latest"></script>
  <style>
/* --- v4.4.2 mobile & Telegram fixes --- */
html, body { height:auto; min-height:100%; -webkit-text-size-adjust:100%; }
#chartWrap { height:540px !important; max-height:540px; }
#tvchart { width:100% !important; height:100% !important; min-height:540px !important; }
.seg { display:grid; grid-auto-flow:row; grid-template-columns: repeat(auto-fit, minmax(72px, 1fr)); gap:8px; align-items:stretch; }
.seg > button { min-width:0; white-space:nowrap; }
.btn { max-width:100%; }
@supports (padding: max(0px)) {
  body { padding-bottom: max(env(safe-area-inset-bottom), 0px); }
}
/* --- end fixes --- */

    :root{
      --bg0:#0b1020; --bg1:#120a22; --bg2:#1a1233;
      --card:#100b1f; --muted:#b2a9d9; --text:#e8e3ff;
      --border:#2a2150;
      --green:#22c55e; --red:#ef4444; --blue:#38bdf8;
      --pink:#ec4899; --violet:#8b5cf6;
    }
    html,body{height:100%;}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 60% -12%, rgba(124,58,237,.18), transparent 55%),
        radial-gradient(900px 520px at 5% 15%, rgba(168,85,247,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;
    }
    .wrap{max-width:1220px; margin:8px auto; padding:0 12px 28px;}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.008));
      border:1px solid var(--border); border-radius:16px; padding:10px;
      box-shadow:0 10px 40px rgba(18,10,34,.45), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .spacer{flex:1 1 auto;}
    .input{
      flex:1 1 240px; background:#110a23; border:1px solid var(--border);
      color:#efeaff; border-radius:12px; padding:12px; outline:none;
      box-shadow:inset 0 0 0 1px rgba(124,58,237,.15);
    }
    .input:focus{ box-shadow:0 0 0 2px rgba(124,58,237,.35), inset 0 0 0 1px rgba(124,58,237,.25); }
    .heading{font-weight:800; margin:8px 0;}
    .badge{
      border:1px solid var(--border); background:linear-gradient(180deg, #120a22, #0f0a1d);
      border-radius:12px; padding:6px 10px; color:#dcd2ff;
      box-shadow:inset 0 0 0 1px rgba(124,58,237,.12);
    }
    .mini{font-size:12px; color:#cfc7f1;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}

    .neon-wrap{display:grid; grid-template-columns: repeat(2, minmax(120px,1fr)); gap:8px;}
    @media (min-width: 640px){ .neon-wrap{grid-template-columns: repeat(2, 1fr);} }
    @media (min-width: 980px){ .neon-wrap{grid-template-columns: repeat(2, 1fr);} }


    /* Pulses */
    @keyframes pulseRed { 0%,100%{ box-shadow:0 0 0 1px rgba(239,68,68,.25), 0 0 12px rgba(239,68,68,.18), inset 0 0 0 1px rgba(239,68,68,.18);} 50%{ box-shadow:0 0 0 1px rgba(239,68,68,.45), 0 0 18px rgba(239,68,68,.28), inset 0 0 0 1px rgba(239,68,68,.28);} }
    @keyframes pulsePink { 0%,100%{ box-shadow:0 0 0 1px rgba(236,72,153,.28), 0 0 14px rgba(236,72,153,.22), inset 0 0 0 1px rgba(236,72,153,.22);} 50%{ box-shadow:0 0 0 1px rgba(139,92,246,.6), 0 0 22px rgba(139,92,246,.35), inset 0 0 0 1px rgba(139,92,246,.35);} }
    @keyframes pulseAppPnL { 0%,100%{ box-shadow:0 0 0 1px rgba(139,92,246,.45), 0 0 14px rgba(139,92,246,.25), inset 0 0 0 1px rgba(139,92,246,.25);} 50%{ box-shadow:0 0 0 1px rgba(139,92,246,.65), 0 0 22px rgba(139,92,246,.45), inset 0 0 0 1px rgba(139,92,246,.45);} }
    @keyframes flashLine { from{opacity:0; filter:brightness(1.1)} 50%{opacity:1; filter:brightness(1.25)} to{opacity:1; filter:brightness(1)} }

    .btn{
      background:#160e2a; color:#efeaff; border:1px solid rgba(124,58,237,.65);
      border-radius:14px; padding:11px 12px; cursor:pointer; user-select:none; text-align:center;
      box-shadow:0 0 0 1px rgba(124,58,237,.45), 0 0 12px rgba(124,58,237,.25), inset 0 0 0 1px rgba(124,58,237,.25);
      transition: transform .14s ease, box-shadow .22s ease, filter .22s ease;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .btn:hover{ transform: translateY(-2px); filter: brightness(1.04); }
    .btn{ touch-action: manipulation; }
    .btn-pulse-red{ animation: pulseRed 3s ease-in-out infinite; }
    .btn-pulse-pink{ animation: pulsePink 3s ease-in-out infinite; }
    .btn-pulse-app-pnl{ animation: pulseAppPnL 3s ease-in-out infinite; }

    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Wallet –∏ –ê–ª–µ—Ä—Ç—ã */
    .btn-group-top{
        display:flex;
        gap:8px;
        margin-top:8px;
    }

    .seg{display:inline-flex; gap:6px; padding:4px; border-radius:12px; background:#120a22; border:1px solid var(--border);}
    .seg button{background:transparent; color:#d6ceff; border:1px solid transparent; padding:6px 10px; border-radius:10px; cursor:pointer}
    .seg button.active{background:rgba(124,58,237,.18); color:#fff; border-color:#5531b5; box-shadow:inset 0 0 0 1px rgba(124,58,237,.28);}

    #chartWrap{height:540px; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#0a1228; position:relative; margin-top:8px;}
    #tvchart{height:100%;}

    .drawer{position:absolute; inset:0; background:rgba(16, 11, 31, .98); border-radius:14px; display:none; flex-direction:column; z-index:10;}
    .drawer.show{ display:flex; }
    .drawer .head{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--border); gap:8px;}
    .drawer .title{font-size:16px; font-weight:800;}
    .drawerBody{padding:10px; overflow:auto; height:100%; scroll-behavior:smooth;}

    .n-blue{ color:var(--blue); text-shadow:0 0 10px rgba(56,189,248,.5), 0 0 20px rgba(96,165,250,.35); }
    .n-green{ color:var(--green); text-shadow:0 0 10px rgba(34,197,94,.5), 0 0 20px rgba(34,197,94,.35); }
    .n-red{ color:var(--red); text-shadow:0 0 10px rgba(239,68,68,.55), 0 0 20px rgba(239,68,68,.35); }

    .agent-line.flash{ animation: flashLine .4s ease both; }
    .agent-line{display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:700;}
    .agent-line .mono{font-weight:600;}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <input id="sym" class="input mono" list="symList" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: BTCUSDT" spellcheck="false"/>
      <datalist id="symList"></datalist>
      <button class="btn" id="btnFind">–ù–∞–π—Ç–∏</button>
    </div>
    
    <!-- Wallet –∏ –ê–ª–µ—Ä—Ç—ã - –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ -->
    <div class="btn-group-top">
        <button class="btn btn-pulse-pink" id="btnWallet">Wallet</button>
        <button class="btn btn-pulse-pink" id="btnAlerts">–ê–ª–µ—Ä—Ç—ã</button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫, 2 –∫–æ–ª–æ–Ω–∫–∏ -->
    <div class="neon-wrap" style="margin-top:8px;">
        <button class="btn" id="btnCopy">–ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥</button>
        <button class="btn" id="btnSpreads">–°–ø—Ä–µ–¥—ã</button>
        <button class="btn" id="btnDeFi">DeFi</button>
        <button class="btn" id="btnSignals">–°–∏–≥–Ω–∞–ª—ã 10x</button>
        <button class="btn" id="btnFav">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
        <button class="btn btn-pulse-app-pnl" id="btnAppPnL">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å App</button>
        <button class="btn" id="btnSetups">–°–µ—Ç–∞–ø—ã</button>
        <button class="btn" id="btnAnomalies">–ê–Ω–æ–º–∞–ª–∏–∏</button>
        <button class="btn" id="btnTop">–¢–æ–ø —Ä–æ—Å—Ç/–ø–∞–¥–µ–Ω–∏–µ</button>
        <button class="btn" id="btnListings">–õ–∏—Å—Ç–∏–Ω–≥–∏</button>
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="row" style="align-items:center;">
      <div class="heading" style="margin:0">
        <div id="agentLine" class="agent-line">
          <span id="agentStateIcon" class="mono n-blue">üîµ FLAT</span>
          <span id="agentSym" class="mono n-blue">BTCUSDT</span>
          <span class="mono">‚Ä¢ Entry: <span id="entryV" class="mono n-blue">‚Äî</span></span>
          <span class="mono">‚Ä¢ TP: <span id="tpV" class="mono n-green">‚Äî</span></span>
          <span class="mono">‚Ä¢ SL: <span id="slV" class="mono n-red">‚Äî</span></span>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="seg" id="autoSeg"><button class="active" data-sec="5">5s</button><button data-sec="10">10s</button><button data-sec="15">15s</button></div>
    </div>

    <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px;">
      <span class="badge">–°–∏–≥–Ω–∞–ª: <span class="mono" id="sidePill">‚Äî</span></span>
      <span class="badge">Auto: <span class="mono" id="autoLbl">5s</span></span>
      <span class="badge">–¶–µ–Ω–∞: <span class="mono" id="lastV">‚Äî</span></span>
      <span class="badge">RSI14: <span class="mono" id="rsiV">‚Äî</span></span>
      <span class="badge">EMA50: <span class="mono" id="ema50V">‚Äî</span></span>
      <span class="badge">EMA200: <span class="mono" id="ema200V">‚Äî</span></span>
      <span class="badge">RR: <span class="mono" id="rrV">‚Äî</span></span>
      <span class="badge">Conf: <span class="mono" id="confV">‚Äî</span></span>
      <span class="badge" id="wsState">WS: offline</span>
    </div>

    <div id="chartWrap">
      <div id="tvchart"></div>
      <div class="drawer" id="drawer">
        <div class="head">
          <div class="title" id="drawerTitle">‚Äî</div>
          <button class="btn" id="drawerClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="drawerBody" id="drawerBody"></div>
      </div>
    </div>
  </div>

  <div class="card" id="oiCard" style="margin-top:10px;">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div class="heading" id="oiHeader" style="margin:0">Open Interest ‚Äî <span id="oiTitleSym">BTCUSDT</span> <span id="oiHint" class="mini mono n-blue" style="margin-left:8px;">‚Äî</span></div>
      <div class="seg" id="oiSeg"><button class="active" data-int="5min">5m</button><button data-int="15min">15m</button><button data-int="1h">1h</button></div>
    </div>
    <div class="mini">Taker Buy: <span class="mono" id="takerBuy">‚Äî</span></div>
    <div class="mini">Taker Sell: <span class="mono" id="takerSell">‚Äî</span></div>
    <div class="mini">Open Interest: <span class="mono" id="oiNow">‚Äî</span></div>
    <div class="mini">ŒîOI: <span class="mono" id="oiDelta">‚Äî</span></div>
    <div class="mini">Funding: <span class="mono" id="fundingNow">‚Äî</span></div>
    <div class="mini muted" id="oiUpdated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>
  </div>
</div>


<script>
(function() {
  // Telegram Mini App init
  if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    const tg = Telegram.WebApp; tg.ready(); tg.expand();
    window.tgUser = tg.initDataUnsafe?.user || null;
    window.tgAlert = (m) => tg.showAlert ? tg.showAlert(m) : alert(m);
  } else {
    window.tgAlert = (m) => alert(m);
  }
})();

const API = "https://api.bybit.com";
const $ = (id) => document.getElementById(id);

const by = async (path, params = {}) => {
  const url = new URL(API + path);
  url.search = new URLSearchParams(params).toString();
  const r = await fetch(url);
  if (!r.ok) throw new Error(await r.text());
  const j = await r.json();
  if (j.retMsg !== 'OK') throw new Error(j.retMsg);
  return j.result;
};

// --- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –ü–ö)
const drawer = $('drawer');
const drawerTitle = $('drawerTitle');
const drawerBody = $('drawerBody');
const drawerClose = $('drawerClose');

function openDrawer(title, content = '') {
  drawerTitle.textContent = title;
  drawerBody.innerHTML = content || `<p>${title} ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>`;
  drawer.classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeDrawer() {
  drawer.classList.remove('show');
  document.body.style.overflow = '';
}

document.querySelectorAll('button.btn').forEach(btn => {
  if (btn.id !== 'btnFind') {
    const handler = e => {
      e.preventDefault();
      openDrawer(btn.textContent.trim());
    };
    btn.addEventListener('click', handler);
    btn.addEventListener('touchend', handler);
  }
});

drawerClose.addEventListener('click', closeDrawer);
drawerClose.addEventListener('touchend', closeDrawer);

drawer.addEventListener('click', (e) => {
  if (e.target === drawer) closeDrawer();
});
</script>

</body>
</html>
