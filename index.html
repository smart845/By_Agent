<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="theme-color" content="#120a22"/>
  <title>ByAgent Terminal</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://unpkg.com/@tonconnect/sdk@latest"></script>
  <style>
    :root{
      --bg0:#0b1020; --bg1:#120a22; --bg2:#1a1233;
      --card:#100b1f; --muted:#b2a9d9; --text:#e8e3ff;
      --accent:#7c3aed; --accent-2:#a855f7;
      --border:#2a2150; --neon:#7c3aed;
      --green:#22c55e; --red:#ef4444; --blue:#38bdf8; --yellow:#eab308;
    }
    html,body{height:100%;}
    body{margin:0; color:var(--text); background:radial-gradient(1200px 600px at 60% -12%, rgba(124,58,237,.18), transparent 55%),radial-gradient(900px 520px at 5% 15%, rgba(168,85,247,.12), transparent 60%),linear-gradient(180deg, var(--bg1), var(--bg0)); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;}
    .wrap{max-width:1220px; margin:8px auto; padding:0 12px 28px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.008)); border:1px solid var(--border); border-radius:16px; padding:10px; box-shadow:0 10px 40px rgba(18,10,34,.45), inset 0 0 0 1px rgba(255,255,255,.02);}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .spacer{flex:1 1 auto;}
    .input{flex:1 1 240px; background:#110a23; border:1px solid var(--border); color:#efeaff; border-radius:12px; padding:12px; outline:none; box-shadow:inset 0 0 0 1px rgba(124,58,237,.15);}
    .input:focus{ box-shadow:0 0 0 2px rgba(124,58,237,.35), inset 0 0 0 1px rgba(124,58,237,.25); }
    .heading{font-weight:800; margin:8px 0;}
    .badge{border:1px solid var(--border); background:linear-gradient(180deg, #120a22, #0f0a1d); border-radius:12px; padding:6px 10px; color:#dcd2ff; box-shadow:inset 0 0 0 1px rgba(124,58,237,.12);}
    .mini{font-size:12px; color:#cfc7f1;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
    .neon-wrap{display:grid; grid-template-columns: repeat(5, minmax(120px,1fr)); gap:8px;}
    .neon-wrap.two{grid-template-columns: repeat(5, minmax(120px,1fr));}
    @media (max-width: 980px){ .neon-wrap{grid-template-columns: repeat(3, 1fr);} .neon-wrap.two{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 640px){ .neon-wrap{grid-template-columns: repeat(2, 1fr);} .neon-wrap.two{grid-template-columns: repeat(2, 1fr);} }
    @keyframes softPulseGreenStrong { 0%,100%{ box-shadow:0 0 0 1px rgba(34,197,94,.35), 0 0 14px rgba(34,197,94,.25), inset 0 0 0 1px rgba(34,197,94,.25);} 50%{ box-shadow:0 0 0 1px rgba(34,197,94,.65), 0 0 22px rgba(34,197,94,.38), inset 0 0 0 1px rgba(34,197,94,.38);} }
    @keyframes softPulseRed { 0%,100%{ box-shadow:0 0 0 1px rgba(239,68,68,.25), 0 0 12px rgba(239,68,68,.18), inset 0 0 0 1px rgba(239,68,68,.18);} 50%{ box-shadow:0 0 0 1px rgba(239,68,68,.45), 0 0 18px rgba(239,68,68,.28), inset 0 0 0 1px rgba(239,68,68,.28);} }
    @keyframes flashLine { from{opacity:0; filter:brightness(1.1)} 50%{opacity:1; filter:brightness(1.25)} to{opacity:1; filter:brightness(1)} }
    .btn{background:#160e2a; color:#efeaff; border:1px solid rgba(124,58,237,.65); border-radius:14px; padding:11px 12px; cursor:pointer; user-select:none; text-align:center; box-shadow:0 0 0 1px rgba(124,58,237,.45), 0 0 12px rgba(124,58,237,.25), inset 0 0 0 1px rgba(124,58,237,.25); transition: transform .14s ease, box-shadow .22s ease, filter .22s ease; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .btn:hover{ transform: translateY(-2px); filter: brightness(1.04); }
    .btn-soft-green-strong{ animation: softPulseGreenStrong 3s ease-in-out infinite; }
    .btn-soft-red{ animation: softPulseRed 3s ease-in-out infinite; }
    .seg{display:inline-flex; gap:6px; padding:4px; border-radius:12px; background:#120a22; border:1px solid var(--border);}
    .seg button{background:transparent; color:#d6ceff; border:1px solid transparent; padding:6px 10px; border-radius:10px; cursor:pointer}
    .seg button.active{background:rgba(124,58,237,.18); color:#fff; border-color:#5531b5; box-shadow:inset 0 0 0 1px rgba(124,58,237,.28);}
    #chartWrap{height:540px; border:1px solid var(--border); border-radius:14px; overflow:hidden; background:#0a1228; position:relative; margin-top:8px;}
    #tvchart{height:100%;}
    .drawer{position:absolute; inset:8px; background:rgba(16, 11, 31, .92); border:1px solid var(--border); border-radius:14px; display:none; flex-direction:column;}
    .drawer.show{ display:flex; }
    .drawer .head{display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid var(--border); gap:8px; backdrop-filter: blur(10px);}
    .drawer .title{font-size:16px; font-weight:800;}
    .drawerBody{padding:10px; overflow:auto; height:100%; scroll-behavior:smooth;}
    .n-blue{ color:var(--blue); text-shadow:0 0 10px rgba(56,189,248,.5), 0 0 20px rgba(96,165,250,.35); }
    .n-green{ color:var(--green); text-shadow:0 0 10px rgba(34,197,94,.5), 0 0 20px rgba(34,197,94,.35); }
    .n-red{ color:var(--red); text-shadow:0 0 10px rgba(239,68,68,.55), 0 0 20px rgba(239,68,68,.35); }
    .agent-line.flash{ animation: flashLine .4s ease both; }
    .agent-line{display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-weight:700;}
    .agent-line .mono{font-weight:600;}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="row">
      <input id="sym" class="input mono" list="symList" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: BTCUSDT" spellcheck="false"/>
      <datalist id="symList"></datalist>
      <button class="btn btn-soft-green-strong" id="btnFind">–ù–∞–π—Ç–∏</button>
      <button class="btn btn-soft-green-strong" id="btnWallet">Wallet</button>
    </div>
    <div class="neon-wrap" style="margin-top:8px;">
      <button class="btn btn-soft-green-strong" id="btnCopy">–ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥</button>
      <button class="btn btn-soft-green-strong" id="btnSpreads">–°–ø—Ä–µ–¥—ã</button>
      <button class="btn btn-soft-green-strong" id="btnDeFi">DeFi</button>
      <button class="btn btn-soft-green-strong" id="btnSignals">–°–∏–≥–Ω–∞–ª—ã 10x</button>
      <button class="btn btn-soft-green-strong" id="btnFav">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
    </div>
    <div class="neon-wrap two" style="margin-top:8px;">
      <button class="btn btn-soft-green-strong" id="btnSetups">–°–µ—Ç–∞–ø—ã</button>
      <button class="btn btn-soft-green-strong" id="btnAnomalies">–ê–Ω–æ–º–∞–ª–∏–∏</button>
      <button class="btn btn-soft-green-strong" id="btnTop">–¢–æ–ø —Ä–æ—Å—Ç/–ø–∞–¥–µ–Ω–∏–µ</button>
      <button class="btn btn-soft-green-strong" id="btnListings">–õ–∏—Å—Ç–∏–Ω–≥–∏</button>
      <button class="btn btn-soft-red" id="btnAppPnL">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å App</button>
    </div>
  </div>

  <div class="card" style="margin-top:10px;">
    <div class="row" style="align-items:center;">
      <div class="heading" style="margin:0">
        <div id="agentLine" class="agent-line">
          <span id="agentStateIcon" class="mono n-blue">üîµ FLAT</span>
          <span id="agentSym" class="mono n-blue">BTCUSDT</span>
          <span class="mono">‚Ä¢ Entry: <span id="entryV" class="mono n-blue">‚Äî</span></span>
          <span class="mono">‚Ä¢ TP: <span id="tpV" class="mono n-green">‚Äî</span></span>
          <span class="mono">‚Ä¢ SL: <span id="slV" class="mono n-red">‚Äî</span></span>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="seg" id="autoSeg"><button class="active" data-sec="5">5s</button><button data-sec="10">10s</button><button data-sec="15">15s</button></div>
      <button class="btn btn-soft-red" id="btnAlerts">–ê–ª–µ—Ä—Ç—ã</button>
    </div>

    <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px;">
      <span class="badge">–°–∏–≥–Ω–∞–ª: <span class="mono" id="sidePill">‚Äî</span></span>
      <span class="badge">Auto: <span class="mono" id="autoLbl">5s</span></span>
      <span class="badge">–¶–µ–Ω–∞: <span class="mono" id="lastV">‚Äî</span></span>
      <span class="badge">RSI14: <span class="mono" id="rsiV">‚Äî</span></span>
      <span class="badge">EMA50: <span class="mono" id="ema50V">‚Äî</span></span>
      <span class="badge">EMA200: <span class="mono" id="ema200V">‚Äî</span></span>
      <span class="badge">RR: <span class="mono" id="rrV">‚Äî</span></span>
      <span class="badge">Conf: <span class="mono" id="confV">‚Äî</span></span>
      <span class="badge" id="wsState">WS: offline</span>
    </div>

    <div id="chartWrap">
      <div id="tvchart"></div>
      <div class="drawer" id="drawer">
        <div class="head">
          <div class="title" id="drawerTitle">‚Äî</div>
          <button class="btn btn-soft-red" id="drawerClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="drawerBody" id="drawerBody"></div>
      </div>
    </div>
  </div>

  <div class="card" id="oiCard" style="margin-top:10px;">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div class="heading" id="oiHeader" style="margin:0">Open Interest ‚Äî <span id="oiTitleSym">BTCUSDT</span> <span id="oiHint" class="mini mono n-blue" style="margin-left:8px;">‚Äî</span></div>
      <div class="seg" id="oiSeg"><button class="active" data-int="5min">5m</button><button data-int="15min">15m</button><button data-int="1h">1h</button></div>
    </div>
    <div class="mini">Taker Buy: <span class="mono" id="takerBuy">‚Äî</span></div>
    <div class="mini">Taker Sell: <span class="mono" id="takerSell">‚Äî</span></div>
    <div class="mini">Open Interest: <span class="mono" id="oiNow">‚Äî</span></div>
    <div class="mini">ŒîOI: <span class="mono" id="oiDelta">‚Äî</span></div>
    <div class="mini">Funding: <span class="mono" id="fundingNow">‚Äî</span></div>
    <div class="mini muted" id="oiUpdated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ‚Äî</div>
  </div>
</div>

<script>
(function(){
  if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
    const tg = Telegram.WebApp; tg.ready(); tg.expand();
    window.tgUser = tg.initDataUnsafe?.user || null;
    window.tgAlert = (m)=> tg.showAlert ? tg.showAlert(m) : alert(m);
  } else {
    window.tgAlert = (m)=> alert(m);
  }
})();

const API = "https://api.bybit.com";
const $ = (id)=> document.getElementById(id);
const fmtVol = (v)=>{ v=+v; if(!isFinite(v)) return "‚Äî"; if (v>=1e12) return (v/1e12).toFixed(2)+" T"; if (v>=1e9) return (v/1e9).toFixed(2)+" B"; if (v>=1e6) return (v/1e6).toFixed(2)+" M"; if (v>=1e3) return (v/1e3).toFixed(2)+" K"; return v.toFixed(0); };
const by = async (path, params={})=>{ const url=new URL(API+path); Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v)); const r=await fetch(url,{mode:"cors"}); const j=await r.json(); if(!r.ok||j.retCode!==0) throw new Error(j.retMsg||("HTTP "+r.status)); return j.result; };
const nowStr = ()=> new Date().toLocaleTimeString();
function ensureUSDT(s){ s=(s||'').toUpperCase().trim(); if(!s) return s; const hasQuote=/USDT|USDC|USD|PERP|USD‚ìà|EUR$/.test(s); return hasQuote? s : s+'USDT'; }

// Drawer
const drawer = $('drawer'), drawerBody=$('drawerBody'), drawerTitle=$('drawerTitle');
function showDrawer(title, html){ try{ $('tvchart').style.display='none'; }catch{} drawerTitle.textContent = title||'‚Äî'; drawerBody.innerHTML = html || '<div class="mini">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; drawer.classList.add('show'); }
function hideDrawer(){ drawer.classList.remove('show'); try{ $('tvchart').style.display='block'; }catch{} }
$('drawerClose').addEventListener('click', hideDrawer);

// Indicators
function SMA(a,p){ const o=[]; let s=0; for(let i=0;i<a.length;i++){ s+=a[i]; if(i>=p) s-=a[i-p]; o.push(i>=p-1? s/p : NaN);} return o; }
function EMA(a,p){ const k=2/(p+1); let o=[],prev=null; for(const v of a){ prev=(prev==null?v:v*k+prev*(1-k)); o.push(prev);} return o; }

// Data (Bybit linear only)
async function getInstruments(){ const lin=await by("/v5/market/instruments-info",{category:"linear"}).catch(()=>({list:[]})); const out=(lin.list||[]).map(x=>x.symbol); return out.sort(); }
async function getTickerSmart(symbol){ const r=await by("/v5/market/tickers",{category:"linear",symbol}); if(r.list?.[0]) return {...r.list[0],category:"linear"}; throw new Error("Symbol not found"); }
async function getKlines(symbol, category, interval='15', limit=300){ const r=await by('/v5/market/kline',{category,symbol,interval,limit}); return (r.list||[]).map(row=>({ts:+row[0],open:+row[1],high:+row[2],low:+row[3],close:+row[4],volume:+row[5]})).sort((a,b)=>a.ts-b.ts); }
async function getOI(symbol,category,intervalTime='5min'){ const r=await by('/v5/market/open-interest',{category,symbol,intervalTime}); const arr=r.list||[]; const last=arr.at(-1)||null, prev=arr.at(-2)||null; const norm=x=>x?(+x.openInterestValue||+x.openInterest||NaN):NaN; return {now:norm(last), prev:norm(prev)}; }
async function getTakerFromTrades(symbol,category,n=800){ const r=await by('/v5/market/recent-trade',{category,symbol,limit:Math.min(1000,n)}); const list=r.list||[]; let buy=0,sell=0; for(const t of list){ const px=+t.price, sz=+t.size, q=(isFinite(px)&&isFinite(sz))?px*sz:0; if(t.side==='Buy') buy+=q; else sell+=q; } return {buy,sell,total:buy+sell}; }

// Realtime
let ws=null;
function connectWS(symbol,category){ try{ ws?.close(); }catch{} const stream="wss://stream.bybit.com/v5/public/linear"; ws=new WebSocket(stream); ws.onopen=()=>{ ws.send(JSON.stringify({op:"subscribe", args:[`tickers.${symbol}`]})); $('wsState').textContent='WS: online'; }; ws.onclose=()=>{ $('wsState').textContent='WS: offline'; }; ws.onmessage=(m)=>{ try{ const d=JSON.parse(m.data); const t=d?.data; if(!t) return; $('lastV').textContent=t.lastPrice||$('lastV').textContent; }catch{} }; }

// Agent
let prevSide='FLAT';
function applyAgentSide(side){
  const stIcon=$('agentStateIcon'), symEl=$('agentSym'), priceEl=$('lastV'), sideEl=$('sidePill');
  [stIcon,symEl,priceEl,sideEl].forEach(el=>{el.classList.remove('n-green','n-red','n-blue')});
  if(side==='LONG'){ stIcon.textContent='üü¢ LONG'; [stIcon,symEl,priceEl,sideEl].forEach(el=>el.classList.add('n-green')); }
  else if(side==='SHORT'){ stIcon.textContent='üî¥ SHORT'; [stIcon,symEl,priceEl,sideEl].forEach(el=>el.classList.add('n-red')); }
  else { stIcon.textContent='üîµ FLAT'; [stIcon,symEl,priceEl,sideEl].forEach(el=>el.classList.add('n-blue')); }
  $('sidePill').textContent=side;
}
function flashAgentLineIfChanged(side){ if(side!==prevSide){ const line=$('agentLine'); line.classList.remove('flash'); void line.offsetWidth; line.classList.add('flash'); prevSide=side; } }

async function computeAndRender(symbol,category){
  try{
    const candles = await getKlines(symbol,category,'15',300); if(!candles.length) return;
    const close=candles.map(c=>c.close);
    const gains=[0], losses=[0]; for(let i=1;i<close.length;i++){ const d=close[i]-close[i-1]; gains[i]=Math.max(0,d); losses[i]=Math.max(0,-d); }
    const rsi14=(function(){ const ag=SMA(gains,14), al=SMA(losses,14); return ag.map((g,i)=>{ const l=al[i]||0; if(i<13) return NaN; const rs=l===0?100:g/l; return 100-(100/(1+rs)); }); })();
    const ema50=EMA(close,50), ema200=EMA(close,200);
    const last=close.at(-1), lastRSI=rsi14.at(-1);

    let conf=0; if(last>(ema50.at(-1)||Infinity)&&last>(ema200.at(-1)||Infinity)) conf++; if((lastRSI||0)>55) conf++;
    const side=(conf>=2)?'LONG':((lastRSI<45)?'SHORT':'FLAT');
    applyAgentSide(side); flashAgentLineIfChanged(side);

    $('agentSym').textContent = currentSymbol;
    $('lastV').textContent=(last||0).toFixed(6);
    $('rrV').textContent='‚âà1:1.6'; $('confV').textContent=conf;
    $('rsiV').textContent = isFinite(lastRSI)? lastRSI.toFixed(1) : '‚Äî';
    $('ema50V').textContent = isFinite(ema50.at(-1))? ema50.at(-1).toFixed(6) : '‚Äî';
    $('ema200V').textContent = isFinite(ema200.at(-1))? ema200.at(-1).toFixed(6) : '‚Äî';

    const entry = last;
    const tp = side==='LONG' ? entry*1.012 : (side==='SHORT'? entry*0.988 : NaN);
    const sl = side==='LONG' ? entry*0.994 : (side==='SHORT'? entry*1.006 : NaN);
    $('entryV').textContent = isFinite(entry)? entry.toFixed(6):'‚Äî';
    $('tpV').textContent = isFinite(tp)? tp.toFixed(6):'‚Äî';
    $('slV').textContent = isFinite(sl)? sl.toFixed(6):'‚Äî';
  }catch(e){ console.warn(e); }
}

// OI
async function refreshOI(symbol,category){
  try{
    const btn=document.querySelector('#oiSeg .active')||$('oiSeg').children[0]; const intervalTime=btn.dataset.int;
    const {now,prev}=await getOI(symbol,category,intervalTime);
    $('oiNow').textContent=isFinite(now)? fmtVol(now):'‚Äî'; const dlt=(isFinite(now)&&isFinite(prev))? (now-prev):NaN;
    $('oiDelta').textContent = isFinite(dlt)? ((dlt>=0?'+':'')+fmtVol(dlt)):'‚Äî';
    $('oiDelta').classList.toggle('n-green', isFinite(dlt)&&dlt>0);
    $('oiDelta').classList.toggle('n-red', isFinite(dlt)&&dlt<0);
  }catch{ $('oiNow').textContent='‚Äî'; $('oiDelta').textContent='‚Äî'; }

  try{
    const tv=await getTakerFromTrades(symbol,category,800); const tot=tv.total||0; const buy=tv.buy||0; const sell=tv.sell||0;
    $('takerBuy').textContent = fmtVol(buy) + (tot? (' ' + ((buy/tot*100).toFixed(1))+'%'):''); 
    $('takerSell').textContent = fmtVol(sell) + (tot? (' ' + ((sell/tot*100).toFixed(1))+'%'):''); 
    $('takerBuy').classList.toggle('n-green', buy>sell); $('takerSell').classList.toggle('n-red', sell>buy);
    const isUp = buy>sell, isDown=sell>buy;
    const hint = isUp ? 'üü¢ –ü–æ–∫—É–ø–∞—Ç–µ–ª–∏ –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç' : (isDown ? 'üî¥ –ü—Ä–æ–¥–∞–≤—Ü—ã –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç' : 'üîµ –ë–∞–ª–∞–Ω—Å');
    const hEl=$('oiHint'); hEl.textContent=hint; hEl.classList.remove('n-green','n-red','n-blue'); hEl.classList.add(isUp?'n-green': (isDown?'n-red':'n-blue'));
    const oiHeader = $('oiHeader'); oiHeader.classList.remove('n-green','n-red','n-blue'); oiHeader.classList.add(isUp ? 'n-green' : (isDown ? 'n-red' : 'n-blue'));
    $('oiUpdated').textContent='–û–±–Ω–æ–≤–ª–µ–Ω–æ: '+nowStr();
  }catch{ $('takerBuy').textContent='‚Äî'; $('takerSell').textContent='‚Äî'; $('oiHint').textContent='‚Äî'; }
  try{ const t=await getTickerSmart(symbol); $('fundingNow').textContent=(t.fundingRate!=null? (+t.fundingRate*100).toFixed(4)+'%':'‚Äî'); }catch{ $('fundingNow').textContent='‚Äî'; }
}
$('oiSeg').addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; [...$('oiSeg').children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); refreshOI(currentSymbol,currentCategory); });

// TradingView
function tvSymbol(symbol){ return 'BYBIT:'+symbol+'.P'; }
function mountTV(symbol){ try{ if(window.tvWidget){ window.tvWidget.remove(); window.tvWidget=null; } }catch{} setTimeout(()=>{ try{ window.tvWidget=new TradingView.widget({ autosize:true, symbol:tvSymbol(symbol), interval:'15', container_id:'tvchart', timezone:'Etc/UTC', theme:'dark', style:'1', locale:'ru', withdateranges:true, allow_symbol_change:true, hide_top_toolbar:false, hide_side_toolbar:false, studies:[] }); }catch(e){} },40); }

// Favorites
const FKEY='byagent_fav_syms';
function loadFav(){ try{ return JSON.parse(localStorage.getItem(FKEY)||'[]'); }catch{return []} }
function saveFav(list){ localStorage.setItem(FKEY, JSON.stringify(list)); }
function addFav(sym){ const list=loadFav(); if(!list.includes(sym)) { list.push(sym); saveFav(list);} }
function delFav(sym){ saveFav(loadFav().filter(x=>x!==sym)); }
function openFavModal(){
  const list=loadFav();
  let html = `<div class="row"><input id="favInput" class="input mono" list="symList" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–∫–µ—Ä (–Ω–∞–ø—Ä. BTC)"/><button class="btn btn-soft-green-strong" id="favAdd">–î–æ–±–∞–≤–∏—Ç—å</button></div>`;
  if(!list.length) html += `<div class="mini" style="margin-top:8px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å —Ç–∏–∫–µ—Ä –≤—ã—à–µ, –æ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.</div>`;
  else {
    html += `<div style="margin-top:8px;"><table><thead><tr><th>–¢–∏–∫–µ—Ä</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>`;
    for(const s of list){ html += `<tr><td class="mono">${s}</td><td><button class="btn" data-go="${s}">–û—Ç–∫—Ä—ã—Ç—å</button> <button class="btn btn-soft-red" data-del="${s}">–£–¥–∞–ª–∏—Ç—å</button></td></tr>`; }
    html += `</tbody></table></div>`;
  }
  showDrawer('‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ', html);
  const input=$('favInput'); input.addEventListener('input', ()=> input.value = ensureUSDT(input.value));
  $('favAdd').onclick = ()=>{ const v=ensureUSDT(input.value||''); if(!v) return; addFav(v); openFavModal(); };
  drawerBody.addEventListener('click',(e)=>{
    const go=e.target.getAttribute('data-go'); const rm=e.target.getAttribute('data-del');
    if(go){ hideDrawer(); selectSymbol(go); }
    if(rm){ delFav(rm); openFavModal(); }
  });
}

// Wallet modal
let tonWalletAddress=null, tonBalance=0;
function shortAddr(a){ return a ? (a.slice(0,4)+'‚Ä¶'+a.slice(-4)) : '‚Äî'; }
function getSubExp(){ const v=localStorage.getItem('byagent_sub_exp'); return v? Number(v):0; }
function setSubExp(days=30){ const ts=Date.now()+days*86400000; localStorage.setItem('byagent_sub_exp', String(ts)); return ts; }
function subExpStr(ts){ return new Date(ts).toLocaleDateString(); }
function openWalletModal(){
  const exp=getSubExp(); const expStr=exp>Date.now()? `‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${subExpStr(exp)}` : 'üîí –ù–µ –∞–∫—Ç–∏–≤–Ω–∞';
  showDrawer('Wallet / –ü–æ–¥–ø–∏—Å–∫–∞ (TON)', `<div class="walletInner">
    <div class="row" style="justify-content:space-between;">
      <div class="title" style="font-weight:800;">Wallet / –ü–æ–¥–ø–∏—Å–∫–∞</div>
      <div class="mini muted">${expStr}</div>
    </div>
    <div class="row" style="margin:8px 0;">
      <button class="btn btn-soft-green-strong" id="btnTonConnect">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å TON Wallet</button>
      <span class="badge mono">–ê–¥—Ä–µ—Å: <span id="wAddr">‚Äî</span></span>
      <span class="badge mono">–ë–∞–ª–∞–Ω—Å: <span id="wBal">‚Äî</span></span>
    </div>
    <div class="heading" style="margin-top:6px;">–ü–æ–¥–ø–∏—Å–∫–∞ ByAgent ‚Äî –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π</div>
    <div class="mini">–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>2 TON</b> (–¥–µ–º–æ-–æ–ø–ª–∞—Ç–∞)</div>
    <div class="row" style="margin-top:6px;">
      <label class="badge"><input type="checkbox" class="ch"> <span>–Ø –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</span></label>
      <label class="badge"><input type="checkbox" class="ch"> <span>–°–æ–≥–ª–∞—Å–µ–Ω —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</span></label>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="btn btn-soft-green-strong" id="btnPay" disabled>–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∑–∞ 2 TON</button>
      <span class="mini muted" id="payHint">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫ –∏ –æ—Ç–º–µ—Ç—å—Ç–µ –æ–±–∞ —á–µ–∫–±–æ–∫—Å–∞</span>
    </div>
  </div>`);
  const wAddrEl=$('wAddr'), wBalEl=$('wBal'), btnPay=$('btnPay'), hint=$('payHint'), btnConn=$('btnTonConnect');
  function updatePayState(){
    const checks=[...drawerBody.querySelectorAll('.ch')].every(x=>x.checked);
    const ok = checks && !!tonWalletAddress && tonBalance>=2;
    btnPay.disabled = !ok;
    hint.textContent = ok ? '–ì–æ—Ç–æ–≤–æ –∫ –æ–ø–ª–∞—Ç–µ (–¥–µ–º–æ). –°—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è.' : (tonWalletAddress? (tonBalance<2?'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å: –Ω—É–∂–Ω–æ ‚â• 2 TON':'–û—Ç–º–µ—Ç—å—Ç–µ —á–µ–∫–±–æ–∫—Å—ã') : '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª—ë–∫');
  }
  drawerBody.querySelectorAll('.ch').forEach(ch=> ch.addEventListener('change', updatePayState));
  btnConn.onclick = ()=>{
    tonWalletAddress = 'EQDemoDemoDemoDemoDemoDemoDemoDemoDEMO';
    tonBalance = 2.5;
    wAddrEl.textContent = shortAddr(tonWalletAddress);
    wBalEl.textContent = tonBalance.toFixed(4)+' TON';
    updatePayState();
  };
  btnPay.onclick = ()=>{
    if(btnPay.disabled) return;
    btnPay.textContent='–û–ø–ª–∞—Ç–∞...';
    setTimeout(()=>{
      const exp=setSubExp(30);
      hint.textContent='‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ (–¥–µ–º–æ). –í—ã –≤ whitelist –Ω–∞ 30 –¥–Ω–µ–π.';
      btnPay.textContent=`–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ ${subExpStr(exp)} (–¥–µ–º–æ)`; btnPay.disabled=true;
    },1000);
  };
}

// Alerts modal
function openAlertsModal(){
  const hasId = !!(window.tgUser && window.tgUser.id);
  const gate = hasId ? '' : `<div class="card" style="margin:6px 0; padding:10px; border:1px dashed #2a2150; border-radius:12px;">
    <div class="mini">üîî –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ <b>@by_agent_bot</b> –∏ –Ω–∞–∂–º–∏ <b>Start</b>.</div>
    <div class="row" style="margin-top:8px;"><a class="btn btn-soft-green-strong" href="https://t.me/by_agent_bot?start=byagent" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞</a></div>
  </div>`;
  showDrawer('–ê–ª–µ—Ä—Ç—ã', `<div class="walletInner">
    ${gate}
    <div class="row" style="justify-content:space-between;">
      <div class="title">–¶–µ–Ω–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã</div><div class="mini muted">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</div>
    </div>
    <div class="row" style="margin-top:10px;">
      <input id="alertSymbol" class="input mono" list="symList" placeholder="–¢–∏–∫–µ—Ä (–Ω–∞–ø—Ä. BTC)" />
      <input id="alertPrice" class="input mono" placeholder="–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞" type="number" step="any"/>
      <div class="seg"><button class="active" data-type="above">–í—ã—à–µ</button><button data-type="below">–ù–∏–∂–µ</button></div>
      <button class="btn btn-soft-green-strong" id="createAlert">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
    <div class="mini" id="alertMsg" style="margin-top:8px;">${ hasId ? '‚Äî' : '–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.'}</div>
  </div>`);
  const symEl = $('alertSymbol'); symEl.value = currentSymbol;
  symEl.addEventListener('input', ()=>{ let v=ensureUSDT(symEl.value); symEl.value = v; });
  let type='above';
  const seg=drawerBody.querySelector('.seg');
  seg.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; [...seg.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); type=b.dataset.type; });
  $('createAlert').onclick=async ()=>{
    if(!hasId){ $('alertMsg').textContent='‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ @by_agent_bot –∏ –Ω–∞–∂–º–∏—Ç–µ Start.'; return; }
    const sym = ensureUSDT(symEl.value||currentSymbol);
    const val=parseFloat($('alertPrice').value); if(!val||isNaN(val)){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É'); return; }
    $('alertMsg').textContent = `‚úÖ –ê–ª–µ—Ä—Ç —Å–æ–∑–¥–∞–Ω –ø–æ ${sym}`; // demo
  };
}

// Movers
function openTopModal(){
  showDrawer('–¢–æ–ø —Ä–æ—Å—Ç/–ø–∞–¥–µ–Ω–∏–µ', `<div class="big-choices"><button class="btn btn-soft-green-strong">üöÄ –¢–æ–ø —Ä–∞—Å—Ç—É—â–∏–µ</button><button class="btn btn-soft-red">üìâ –¢–æ–ø –ø–∞–¥–∞—é—â–∏–µ</button></div><div id="topResult" style="margin-top:8px;"></div>`);
  $('topResult').innerHTML = '<div class="mini">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–¥–µ–º–æ). –ü–æ–¥–∫–ª—é—á–∏–º /api/movers –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.</div>';
}

// Symbol flow (linear only)
let currentSymbol='BTCUSDT', currentCategory='linear';
async function selectSymbol(s){
  try{
    const t=await getTickerSmart(s); currentCategory='linear'; currentSymbol=s; $('sym').value=s;
    connectWS(s,currentCategory); await Promise.all([refreshOI(s,currentCategory), computeAndRender(s,currentCategory)]); mountTV(s);
    $('oiTitleSym').textContent=s;
  }catch{ alert('–°–∏–º–≤–æ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: '+s); }
}

function setAuto(sec){
  $('autoLbl').textContent = sec + 's';
  if (window.__autoTimer) clearInterval(window.__autoTimer);
  window.__autoTimer = setInterval(()=> refreshAll(), sec*1000);
  refreshAll();
}
async function refreshAll(){ await Promise.all([refreshOI(currentSymbol,currentCategory), computeAndRender(currentSymbol,currentCategory)]); }

// UI init
function initUI(){
  $('sym').addEventListener('input', ()=> { const v = $('sym').value; $('sym').value = ensureUSDT(v); });
  $('btnFind').onclick = ()=> selectSymbol( ensureUSDT( $('sym').value||'BTC' ) );
  getInstruments().then(syms=>{ $('symList').innerHTML = syms.map(s=> `<option value="${s}">`).join(''); }).catch(()=>{});

  $('btnTop').onclick = openTopModal;
  $('btnListings').onclick = ()=>{ showDrawer('–õ–∏—Å—Ç–∏–Ω–≥–∏ (–Ω–æ–≤—ã–µ / –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ)','<div class="mini">/api/listings –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–¥–µ–º–æ).</div>'); };
  $('btnSpreads').onclick = ()=>{ showDrawer('–°–ø—Ä–µ–¥—ã ‚Ä¢ '+currentSymbol,'<div class="mini">/api/spreads –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–¥–µ–º–æ).</div>'); };
  $('btnDeFi').onclick = ()=>{ const base=currentSymbol.replace('USDT',''); showDrawer('DeFi –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ ‚Ä¢ '+base,'<div class="mini">/api/defi –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–¥–µ–º–æ).</div>'); };
  $('btnSetups').onclick = ()=>{ showDrawer('–°–µ—Ç–∞–ø—ã (—Ç–æ–ø-10)','<div class="mini">/api/setups –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–¥–µ–º–æ).</div>'); };
  $('btnAnomalies').onclick = ()=>{ showDrawer('–ê–Ω–æ–º–∞–ª–∏–∏','<div class="mini">/api/anomalies –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–¥–µ–º–æ).</div>'); };
  $('btnAlerts').onclick = openAlertsModal;
  $('btnSignals').onclick = ()=> showDrawer('–°–∏–≥–Ω–∞–ª—ã 10x','<div class="mini">–°–∏–≥–Ω–∞–ª—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤ Telegram (–¥–µ–º–æ).</div>');
  $('btnAppPnL').onclick = ()=>{ showDrawer('–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è','<div class="mini">/api/stats –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–¥–µ–º–æ).</div>'); };
  $('btnCopy').onclick = ()=>{ showDrawer('–ö–æ–ø–∏—Ç—Ä–µ–π–¥–∏–Ω–≥ ByAgent Alpha','<div class="mini">/api/leaderboard –ø–æ–¥–∫–ª—é—á–∏–º –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–¥–µ–º–æ).</div>'); };
  $('btnWallet').onclick = openWalletModal;
  $('btnFav').onclick = openFavModal;

  const autoSeg=$('autoSeg');
  autoSeg.addEventListener('click',(e)=>{ const b=e.target.closest('button'); if(!b) return; [...autoSeg.children].forEach(x=>x.classList.remove('active')); b.classList.add('active'); setAuto(parseInt(b.dataset.sec,10)||5); });
  setAuto(5);

  selectSymbol('BTCUSDT');
}

window.addEventListener('DOMContentLoaded', initUI);
</script>
</body>
</html>
